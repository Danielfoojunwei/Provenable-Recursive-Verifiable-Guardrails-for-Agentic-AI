name: Release Installer

on:
  push:
    tags:
      - 'installer-v*'

defaults:
  run:
    working-directory: installer

permissions:
  contents: write

jobs:
  validate:
    name: Pre-release Validation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable

      - name: Build tools
        run: cargo build --manifest-path tools/Cargo.toml

      - name: Validate manifest
        run: tools/target/debug/installer-tools validate

      - name: Regenerate checksums and verify no drift
        run: |
          tools/target/debug/installer-tools gen-checksums
          if ! git diff --exit-code manifest/manifest.json checksums.txt; then
            echo "ERROR: Checksums out of date"
            exit 1
          fi

  smoke-test:
    name: Smoke Test (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    needs: validate
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '22'

      - uses: dtolnay/rust-toolchain@stable

      - name: Build tools
        run: cargo build --manifest-path tools/Cargo.toml

      - name: Run smoke tests
        run: |
          chmod +x install/install-proven-aer.sh scripts/smoke_install_unix.sh
          bash scripts/smoke_install_unix.sh

  release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [validate, smoke-test]
    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable

      - name: Build tools
        run: cargo build --manifest-path tools/Cargo.toml

      - name: Extract version from tag
        id: version
        run: echo "version=${GITHUB_REF_NAME#installer-v}" >> "$GITHUB_OUTPUT"

      - name: Generate checksums
        run: tools/target/debug/installer-tools gen-checksums

      - name: Create release
        uses: softprops/action-gh-release@v2
        with:
          name: "Installer v${{ steps.version.outputs.version }}"
          body: |
            ## Provenable.ai AER Installer v${{ steps.version.outputs.version }}

            ### Quick Install

            **macOS / Linux:**
            ```bash
            curl -sSL https://raw.githubusercontent.com/${{ github.repository }}/main/installer/install/install-proven-aer.sh | bash
            ```

            **Windows (PowerShell):**
            ```powershell
            irm https://raw.githubusercontent.com/${{ github.repository }}/main/installer/install/install-proven-aer.ps1 | iex
            ```

            ### Verification
            See [VERIFY.md](https://github.com/${{ github.repository }}/blob/main/installer/docs/VERIFY.md) for checksum verification instructions.

            ### Security Defaults
            - Binds to `127.0.0.1` (localhost only)
            - `authRequired: true`
            - `trustedProxies: []` (empty)
            - AER guardrails enabled
          files: |
            installer/install/install-proven-aer.sh
            installer/install/install-proven-aer.ps1
            installer/manifest/manifest.json
            installer/checksums.txt
          draft: false
          prerelease: false
